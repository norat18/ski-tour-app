<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ski Tour Decision - PNW Backcountry</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --cream: #F5F1E8;
            --burnt-orange: #D6622C;
            --forest-green: #2C5530;
            --dark-green: #1A3320;
            --steel-blue: #5B7C99;
            --warning-red: #C14236;
            --snow-white: #FDFCFA;
            --topo-gray: #8A8478;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #E8DCC8 100%);
            color: var(--dark-green);
            min-height: 100vh;
            padding: 2rem;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 49px, rgba(42, 85, 48, 0.03) 49px, rgba(42, 85, 48, 0.03) 50px),
                repeating-linear-gradient(90deg, transparent, transparent 49px, rgba(42, 85, 48, 0.03) 49px, rgba(42, 85, 48, 0.03) 50px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--forest-green) 0%, var(--dark-green) 100%);
            padding: 2rem 2.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--burnt-orange), var(--warning-red), var(--burnt-orange));
        }

        h1 {
            color: var(--snow-white);
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 0.5rem;
        }

        .card {
            background: var(--snow-white);
            border-radius: 10px;
            padding: 1.75rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 2px solid rgba(44, 85, 48, 0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--forest-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .btn {
            background: var(--forest-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            background: var(--dark-green);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--forest-green);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .tour-card {
            background: var(--snow-white);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-left: 6px solid var(--forest-green);
        }

        .tour-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--forest-green);
            margin-bottom: 0.5rem;
        }

        .tour-stats {
            font-family: 'Courier Prime', monospace;
            color: var(--topo-gray);
            font-size: 0.9rem;
        }

        .recommendation {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
            display: inline-block;
        }

        .rec-go {
            background: var(--forest-green);
            color: white;
        }

        .rec-maybe {
            background: #FFB84D;
            color: #664400;
        }

        .rec-no {
            background: var(--warning-red);
            color: white;
        }

        /* Search Section Styles */
        .search-section {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .search-section h4 {
            color: var(--forest-green);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .search-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 0.6rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .search-controls select {
            padding: 0.6rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
        }

        /* Search Results - Completely separate container */
        #searchResultsContainer {
            display: none;
            background: #f9f9f9;
            border: 2px solid var(--forest-green);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
        }

        #searchResultsContainer.active {
            display: block;
        }

        .search-result-item {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--steel-blue);
        }

        .search-result-name {
            font-weight: 600;
            color: var(--forest-green);
        }

        .search-result-details {
            font-size: 0.8rem;
            color: var(--topo-gray);
        }

        /* Recommended Tours Section - Separate from search */
        #recommendedToursSection {
            /* This section is always independent of search */
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--forest-green);
            margin: 0;
        }

        .zone-selector select {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 2px solid var(--forest-green);
            border-radius: 8px;
            background: white;
            color: var(--forest-green);
            cursor: pointer;
            min-width: 250px;
        }

        .welcome-message {
            text-align: center;
            padding: 3rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .welcome-message h2 {
            color: var(--forest-green);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .slider-container {
            margin-bottom: 1rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, var(--warning-red) 0%, #FFB84D 50%, var(--forest-green) 100%);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--dark-green);
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--topo-gray);
        }

        .spinner {
            border: 4px solid var(--cream);
            border-top: 4px solid var(--forest-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-banner {
            background: var(--cream);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--topo-gray);
        }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            h1 { font-size: 1.8rem; }
            .dashboard { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Safety Disclaimer -->
    <div style="background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%); color: white; padding: 0.75rem 1rem; text-align: center; font-weight: 600; font-size: 0.95rem; margin-bottom: 1rem; border-radius: 8px;">
        ‚ö†Ô∏è DECISION SUPPORT TOOL ONLY ‚Äî Always make your own informed choices in the backcountry.
    </div>

    <div class="container">
        <header>
            <h1>‚õ∑Ô∏è Ski Tour Decision Dashboard</h1>
            <div class="zone-selector" style="margin-top: 1rem;">
                <select id="nwacZone" onchange="onZoneChange()">
                    <option value="">Choose your zone...</option>
                    <optgroup label="Washington Cascades - West">
                        <option value="west-slopes-north">West Slopes North (Mt Baker)</option>
                        <option value="stevens-pass">Stevens Pass</option>
                        <option value="snoqualmie-pass">Snoqualmie Pass</option>
                    </optgroup>
                    <optgroup label="Washington Cascades - East">
                        <option value="east-slopes-north">East Slopes North</option>
                        <option value="east-slopes-central">East Slopes Central</option>
                    </optgroup>
                    <optgroup label="Other Areas">
                        <option value="olympics">Olympics</option>
                        <option value="mt-hood">Mt Hood</option>
                    </optgroup>
                </select>
            </div>
        </header>

        <!-- Welcome Message (shown before zone selection) -->
        <div id="welcomeMessage" class="welcome-message">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üèîÔ∏è</div>
            <h2>PNW Ski Tours</h2>
            <p style="color: var(--topo-gray); font-size: 1.1rem; margin-bottom: 1rem;">
                Your backcountry ski tour planning companion
            </p>
            <p style="color: var(--forest-green); font-weight: 600;">
                üëÜ Select your zone from the dropdown above to get started
            </p>
        </div>

        <!-- Main Dashboard (hidden until zone selected) -->
        <div id="mainDashboard" style="display: none;">
            
            <!-- Profile Settings -->
            <div class="dashboard">
                <div class="card">
                    <div class="card-title">üéØ My Profile</div>
                    
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><strong>üí™ Energy Level</strong></span>
                            <span id="fitnessValue">7/10</span>
                        </div>
                        <input type="range" id="fitnessSlider" min="1" max="10" value="7" oninput="updateFitness(this.value)">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span><strong>‚õ∑Ô∏è Downhill Skill</strong></span>
                            <span id="downhillValue">5/10</span>
                        </div>
                        <input type="range" id="downhillSlider" min="1" max="10" value="5" oninput="updateDownhill(this.value)">
                    </div>

                    <div class="slider-container">
                        <div class="slider-label">
                            <span><strong>üéø Touring Skill</strong></span>
                            <span id="touringValue">5/10</span>
                        </div>
                        <input type="range" id="touringSlider" min="1" max="10" value="5" oninput="updateTouring(this.value)">
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìä Current Zone</div>
                    <div id="zoneInfo">
                        <p style="font-size: 1.2rem; font-weight: 600; color: var(--forest-green);" id="currentZoneName">-</p>
                        <p style="color: var(--topo-gray);" id="zoneTourCount">-</p>
                    </div>
                </div>
            </div>

            <!-- SEARCH SECTION - Completely independent -->
            <div class="search-section">
                <h4>üîç Search All Tours (All Zones)</h4>
                <div class="search-controls">
                    <input type="text" id="searchInput" placeholder="Search by tour name..." onkeyup="handleSearchKeyup(event)">
                    <select id="searchZoneFilter">
                        <option value="all">All Zones</option>
                        <option value="west-slopes-north">Mt Baker</option>
                        <option value="stevens-pass">Stevens Pass</option>
                        <option value="snoqualmie-pass">Snoqualmie Pass</option>
                        <option value="east-slopes-north">East Slopes North</option>
                        <option value="east-slopes-central">East Slopes Central</option>
                        <option value="olympics">Olympics</option>
                        <option value="mt-hood">Mt Hood</option>
                    </select>
                    <button class="btn btn-primary" onclick="performSearch()">Search</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>
            </div>

            <!-- SEARCH RESULTS - Separate container, only shows when searching -->
            <div id="searchResultsContainer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--steel-blue);">üîé Search Results</h4>
                    <button onclick="clearSearch()" style="background: none; border: none; color: var(--forest-green); cursor: pointer; font-size: 1rem;">‚úï Close</button>
                </div>
                <div id="searchResultsList">
                    <!-- Search results rendered here -->
                </div>
            </div>

            <!-- RECOMMENDED TOURS SECTION - Completely separate from search -->
            <div id="recommendedToursSection">
                <div class="section-header">
                    <h2 class="section-title">üìç Recommended Tours</h2>
                    <button class="btn" onclick="refreshRecommendedTours()" id="refreshBtn">
                        üîÑ New Top 5
                    </button>
                </div>

                <div class="info-banner" id="recommendationInfo">
                    üí° Tours sorted by best match for your profile. Select a zone to see recommendations.
                </div>

                <div id="recommendedToursContent">
                    <div class="loading">
                        <div class="spinner"></div>
                        Select a zone to see tour recommendations...
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Completely separate state
        // ============================================
        
        // State for recommendations (zone-specific)
        let recommendationState = {
            zone: null,
            fitness: 7,
            downhill: 5,
            touring: 5,
            excludedTours: []
        };

        // State for search (global, all zones)
        let searchState = {
            query: '',
            zoneFilter: 'all',
            isActive: false
        };

        // Tour database
        const toursByZone = {
            'west-slopes-north': [
                { name: "Herman Saddle", location: "Mt Baker", elevationGain: 1500, distance: 9, maxElevation: 5400, terrain: "Open bowls, 30-35¬∞" },
                { name: "Table Mountain Circumnav", location: "Mt Baker", elevationGain: 1900, distance: 5, maxElevation: 5742, terrain: "Open slopes, 30-35¬∞" },
                { name: "Skyline Divide", location: "Mt Baker", elevationGain: 2500, distance: 9, maxElevation: 6500, terrain: "Open slopes, <30¬∞" },
                { name: "Mount Ann", location: "Mt Baker", elevationGain: 2500, distance: 9, maxElevation: 5900, terrain: "Open slopes, 30-35¬∞" },
                { name: "Coleman Pinnacle", location: "Mt Baker", elevationGain: 2800, distance: 9, maxElevation: 6400, terrain: "Exposed ridge, 35-40¬∞" },
                { name: "Sholes Glacier", location: "Mt Baker", elevationGain: 3000, distance: 9, maxElevation: 6500, terrain: "Glacier travel" },
                { name: "Park Butte", location: "Mt Baker", elevationGain: 2000, distance: 8, maxElevation: 5450, terrain: "Open slopes, <30¬∞" },
                { name: "Ruth Mt.", location: "Mt Baker", elevationGain: 4035, distance: 8, maxElevation: 7100, terrain: "Open slopes, 30-35¬∞" },
            ],
            'stevens-pass': [
                { name: "Cowboy Mt.", location: "Stevens Pass", elevationGain: 1500, distance: 1.5, maxElevation: 5850, terrain: "Open slopes, 30-35¬∞" },
                { name: "Skyline Ridge", location: "Stevens Pass", elevationGain: 2900, distance: 3, maxElevation: 5978, terrain: "Open slopes, 30-35¬∞" },
                { name: "Big Chief Mt.", location: "Stevens Pass", elevationGain: 3200, distance: 7, maxElevation: 6440, terrain: "Exposed ridge, 35-40¬∞" },
                { name: "Lichtenberg Mt", location: "Stevens Pass", elevationGain: 2700, distance: 8, maxElevation: 5844, terrain: "Open slopes, 30-35¬∞" },
                { name: "Yodelin", location: "Stevens Pass", elevationGain: 2000, distance: 4, maxElevation: 5400, terrain: "Open slopes, 30-35¬∞" },
                { name: "Jim Hill Mt.", location: "Stevens Pass", elevationGain: 3130, distance: 8, maxElevation: 6765, terrain: "Open slopes, 35-40¬∞" },
                { name: "Skyline Lake", location: "Stevens Pass", elevationGain: 1400, distance: 4, maxElevation: 5092, terrain: "Treed, <30¬∞" },
                { name: "Tye Ridge", location: "Stevens Pass", elevationGain: 1800, distance: 4, maxElevation: 5600, terrain: "Open slopes, 30-35¬∞" },
            ],
            'snoqualmie-pass': [
                { name: "Chair Peak Basin", location: "Snoqualmie Pass", elevationGain: 2500, distance: 5, maxElevation: 6238, terrain: "Open slopes, 35-40¬∞" },
                { name: "Pineapple Pass", location: "Snoqualmie Pass", elevationGain: 2000, distance: 4, maxElevation: 5200, terrain: "Open slopes, 30-35¬∞" },
                { name: "Snow Lake Divide", location: "Snoqualmie Pass", elevationGain: 2500, distance: 4, maxElevation: 5400, terrain: "Open slopes, 30-35¬∞" },
                { name: "Kendall Peak", location: "Snoqualmie Pass", elevationGain: 2000, distance: 4, maxElevation: 5784, terrain: "Open slopes, 30-35¬∞" },
                { name: "Mt. Snoqualmie", location: "Snoqualmie Pass", elevationGain: 4000, distance: 6, maxElevation: 6278, terrain: "Open slopes, 35-40¬∞" },
                { name: "Silver Peak", location: "Snoqualmie Pass", elevationGain: 3000, distance: 8, maxElevation: 5605, terrain: "Open slopes, 30-35¬∞" },
                { name: "Granite Mt.", location: "Snoqualmie Pass", elevationGain: 3800, distance: 8, maxElevation: 5629, terrain: "Exposed ridge" },
                { name: "Mt. Catherine", location: "Snoqualmie Pass", elevationGain: 2000, distance: 5, maxElevation: 5052, terrain: "Open slopes, 30-35¬∞" },
            ],
            'east-slopes-north': [
                { name: "Slate Peak", location: "Methow Valley", elevationGain: 1500, distance: 4, maxElevation: 7440, terrain: "Open slopes, 30-35¬∞" },
                { name: "Delancy Ridge", location: "Methow Valley", elevationGain: 2500, distance: 4, maxElevation: 7000, terrain: "Open slopes, 35-40¬∞" },
                { name: "Cutthroat Pass", location: "Methow Valley", elevationGain: 2200, distance: 15.6, maxElevation: 6820, terrain: "Open slopes, <30¬∞" },
                { name: "Heather and Maple Pass", location: "Methow Valley", elevationGain: 4200, distance: 6.5, maxElevation: 7000, terrain: "Open slopes, 30-35¬∞" },
                { name: "Early Winters", location: "Methow Valley", elevationGain: 1800, distance: 4, maxElevation: 6200, terrain: "Open slopes, 30-35¬∞" },
            ],
            'east-slopes-central': [
                { name: "Mission Peak", location: "Mission Ridge", elevationGain: 1000, distance: 2, maxElevation: 6876, terrain: "Open slopes, 30-35¬∞" },
                { name: "Haney Meadow", location: "Mission Ridge", elevationGain: 2000, distance: 9, maxElevation: 5500, terrain: "Open slopes, <30¬∞" },
                { name: "Diamond Head", location: "Mission Ridge", elevationGain: 2200, distance: 5, maxElevation: 5915, terrain: "Open slopes, 30-35¬∞" },
                { name: "Tronsen Meadows", location: "Mission Ridge", elevationGain: 800, distance: 3, maxElevation: 4600, terrain: "Open meadow, <25¬∞" },
            ],
            'olympics': [
                { name: "Hurricane Hill", location: "Olympics", elevationGain: 2000, distance: 6, maxElevation: 5757, terrain: "Open slopes, 30-35¬∞" },
                { name: "Mt. Angeles", location: "Olympics", elevationGain: 1500, distance: 2, maxElevation: 6454, terrain: "Open slopes, 30-35¬∞" },
                { name: "Obstruction Point", location: "Olympics", elevationGain: 3500, distance: 16, maxElevation: 6450, terrain: "Open slopes, 30-35¬∞" },
                { name: "Deer Park", location: "Olympics", elevationGain: 2500, distance: 14, maxElevation: 6007, terrain: "Open slopes, 30-35¬∞" },
                { name: "Mt Ellinor", location: "Olympics", elevationGain: 3280, distance: 8, maxElevation: 5944, terrain: "Open slopes, 35-40¬∞" },
            ],
            'mt-hood': [
                { name: "Mt. Adams", location: "Mt Adams", elevationGain: 6756, distance: 10, maxElevation: 12276, terrain: "Glacier travel" },
                { name: "Mt Saint Helens", location: "Mt St Helens", elevationGain: 5665, distance: 8, maxElevation: 8363, terrain: "Open slopes, 35-40¬∞" },
                { name: "Marble Mt.", location: "Mt St Helens", elevationGain: 1500, distance: 12, maxElevation: 4128, terrain: "Treed, <25¬∞" },
                { name: "June Lake", location: "Mt St Helens", elevationGain: 1500, distance: 4.8, maxElevation: 4200, terrain: "Treed, <30¬∞" },
            ],
        };

        const zoneNames = {
            'west-slopes-north': 'West Slopes North (Mt Baker)',
            'stevens-pass': 'Stevens Pass',
            'snoqualmie-pass': 'Snoqualmie Pass',
            'east-slopes-north': 'East Slopes North',
            'east-slopes-central': 'East Slopes Central',
            'olympics': 'Olympics',
            'mt-hood': 'Mt Hood'
        };

        // ============================================
        // ZONE SELECTION - Only affects recommendations
        // ============================================
        
        function onZoneChange() {
            const zone = document.getElementById('nwacZone').value;
            console.log('üó∫Ô∏è Zone changed to:', zone);
            
            if (!zone) {
                document.getElementById('welcomeMessage').style.display = 'block';
                document.getElementById('mainDashboard').style.display = 'none';
                return;
            }

            // Show dashboard
            document.getElementById('welcomeMessage').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';

            // Update recommendation state (NOT search state)
            recommendationState.zone = zone;
            recommendationState.excludedTours = []; // Reset for new zone

            // Update zone info display
            document.getElementById('currentZoneName').textContent = zoneNames[zone] || zone;
            const tours = toursByZone[zone] || [];
            document.getElementById('zoneTourCount').textContent = `${tours.length} tours available`;

            // Load recommended tours (independent of search)
            loadRecommendedTours();
        }

        // ============================================
        // PROFILE SLIDERS - Only affect recommendations
        // ============================================
        
        function updateFitness(value) {
            recommendationState.fitness = parseInt(value);
            document.getElementById('fitnessValue').textContent = `${value}/10`;
            if (recommendationState.zone) loadRecommendedTours();
        }

        function updateDownhill(value) {
            recommendationState.downhill = parseInt(value);
            document.getElementById('downhillValue').textContent = `${value}/10`;
            if (recommendationState.zone) loadRecommendedTours();
        }

        function updateTouring(value) {
            recommendationState.touring = parseInt(value);
            document.getElementById('touringValue').textContent = `${value}/10`;
            if (recommendationState.zone) loadRecommendedTours();
        }

        // ============================================
        // RECOMMENDED TOURS - Zone-specific, profile-based
        // ============================================
        
        function loadRecommendedTours() {
            console.log('üìç Loading RECOMMENDED tours for zone:', recommendationState.zone);
            
            const content = document.getElementById('recommendedToursContent');
            const zone = recommendationState.zone;
            
            if (!zone) {
                content.innerHTML = '<div class="loading">Select a zone to see recommendations...</div>';
                return;
            }

            const tours = toursByZone[zone] || [];
            
            if (tours.length === 0) {
                content.innerHTML = '<div class="card"><p>No tours available for this zone.</p></div>';
                return;
            }

            // Calculate recommendations based on profile
            const scored = tours.map(tour => ({
                tour,
                score: calculateTourScore(tour)
            }));

            // Sort by score (highest first)
            scored.sort((a, b) => b.score.value - a.score.value);

            // Filter out excluded tours
            let available = scored.filter(s => !recommendationState.excludedTours.includes(s.tour.name));
            
            // Reset if we've shown too many
            if (available.length < 5 && tours.length > 5) {
                recommendationState.excludedTours = [];
                available = scored;
            }

            // Take top 5
            const top5 = available.slice(0, 5);

            // Track as shown
            top5.forEach(s => {
                if (!recommendationState.excludedTours.includes(s.tour.name)) {
                    recommendationState.excludedTours.push(s.tour.name);
                }
            });

            // Update info banner
            document.getElementById('recommendationInfo').innerHTML = `
                üí° Showing <strong>top 5 tours</strong> for <strong>${zoneNames[zone]}</strong> based on:
                Energy: <strong>${recommendationState.fitness}/10</strong> ‚Ä¢ 
                Downhill: <strong>${recommendationState.downhill}/10</strong> ‚Ä¢ 
                Touring: <strong>${recommendationState.touring}/10</strong>
            `;

            // Render tours
            content.innerHTML = top5.map((item, i) => renderRecommendedTour(item.tour, item.score, i + 1)).join('');

            console.log('‚úÖ Rendered', top5.length, 'recommended tours');
        }

        function refreshRecommendedTours() {
            console.log('üîÑ Refreshing recommended tours');
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = 'üîÑ Loading...';
            btn.disabled = true;

            setTimeout(() => {
                loadRecommendedTours();
                btn.innerHTML = 'üîÑ New Top 5';
                btn.disabled = false;
            }, 300);
        }

        function calculateTourScore(tour) {
            const fitness = recommendationState.fitness;
            const downhill = recommendationState.downhill;
            const touring = recommendationState.touring;
            
            let score = 0;
            let level = 'go';
            let text = '‚úÖ Good Choice';

            // Physical difficulty based on elevation gain
            let physDiff = Math.min(10, Math.ceil(tour.elevationGain / 500));
            
            // Technical difficulty based on terrain
            let techDiff = 5;
            const terrain = tour.terrain.toLowerCase();
            if (terrain.includes('<25') || terrain.includes('<30')) techDiff = 3;
            if (terrain.includes('30-35')) techDiff = 5;
            if (terrain.includes('35-40')) techDiff = 6;
            if (terrain.includes('40-')) techDiff = 8;
            if (terrain.includes('glacier')) techDiff = 7;
            if (terrain.includes('exposed')) techDiff += 1;

            // Fitness matching
            const fitDiff = fitness - physDiff;
            if (fitDiff >= 0 && fitDiff <= 3) score += 3;
            else if (fitDiff > 3) score += 2;
            else if (fitDiff >= -2) score += 1;
            else score -= 2;

            // Skill matching
            const skillDiff = downhill - techDiff;
            if (skillDiff >= 0 && skillDiff <= 2) score += 3;
            else if (skillDiff > 2) score += 2;
            else if (skillDiff >= -1) score += 1;
            else score -= 2;

            // Touring skill bonus
            const tourDiff = touring - Math.round((physDiff + techDiff) / 2);
            if (tourDiff >= 0) score += 1;
            else if (tourDiff < -2) score -= 1;

            // Determine level
            if (score >= 4) {
                level = 'go';
                text = '‚úÖ Good Choice';
            } else if (score >= 2) {
                level = 'maybe';
                text = '‚ö†Ô∏è Doable';
            } else {
                level = 'no';
                text = 'üõë Challenging';
            }

            return { value: score, level, text, physDiff, techDiff };
        }

        function renderRecommendedTour(tour, score, rank) {
            return `
                <div class="tour-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <div class="tour-name">
                                <span style="background: var(--burnt-orange); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; margin-right: 0.5rem;">#${rank}</span>
                                ${tour.name}
                            </div>
                            <div class="tour-stats">
                                ${tour.location} ‚Ä¢ ${tour.elevationGain.toLocaleString()} ft gain ‚Ä¢ ${tour.distance} mi
                            </div>
                        </div>
                        <div class="recommendation rec-${score.level}">${score.text}</div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--cream); border-radius: 8px; font-size: 0.9rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem;">
                            <div>‚õ∞Ô∏è <strong>Terrain:</strong> ${tour.terrain}</div>
                            <div>üèîÔ∏è <strong>Max Elev:</strong> ${tour.maxElevation.toLocaleString()} ft</div>
                            <div>üí™ <strong>Physical:</strong> ${score.physDiff}/10</div>
                            <div>‚õ∑Ô∏è <strong>Technical:</strong> ${score.techDiff}/10</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // SEARCH FUNCTIONALITY - Completely separate
        // Does NOT affect recommended tours
        // ============================================
        
        function handleSearchKeyup(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const zoneFilter = document.getElementById('searchZoneFilter').value;
            
            console.log('üîç Performing SEARCH (separate from recommendations)');
            console.log('   Query:', query);
            console.log('   Zone filter:', zoneFilter);

            // Update search state (NOT recommendation state)
            searchState.query = query;
            searchState.zoneFilter = zoneFilter;
            searchState.isActive = true;

            if (!query && zoneFilter === 'all') {
                clearSearch();
                return;
            }

            // Collect ALL tours from ALL zones for search
            const allTours = [];
            for (const [zone, tours] of Object.entries(toursByZone)) {
                tours.forEach(tour => {
                    allTours.push({ ...tour, zoneKey: zone });
                });
            }

            // Filter based on search criteria
            const results = allTours.filter(tour => {
                const nameMatch = !query || tour.name.toLowerCase().includes(query);
                const zoneMatch = zoneFilter === 'all' || tour.zoneKey === zoneFilter;
                return nameMatch && zoneMatch;
            });

            // Sort alphabetically
            results.sort((a, b) => a.name.localeCompare(b.name));

            // Render search results in SEPARATE container
            const container = document.getElementById('searchResultsContainer');
            const list = document.getElementById('searchResultsList');

            if (results.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 1rem; color: var(--topo-gray);">
                        No tours found matching "${query || 'your criteria'}"
                    </div>
                `;
            } else {
                list.innerHTML = `
                    <p style="margin-bottom: 1rem; color: var(--topo-gray);">
                        Found <strong>${results.length}</strong> tour${results.length !== 1 ? 's' : ''}
                    </p>
                    ${results.map(tour => renderSearchResult(tour)).join('')}
                `;
            }

            // Show search results container
            container.classList.add('active');

            console.log('‚úÖ Search complete:', results.length, 'results');
            console.log('   (Recommended tours unchanged)');
        }

        function renderSearchResult(tour) {
            return `
                <div class="search-result-item">
                    <div class="search-result-name">${tour.name}</div>
                    <div class="search-result-details">
                        üìç ${tour.location} (${zoneNames[tour.zoneKey] || tour.zoneKey}) ‚Ä¢ 
                        ${tour.elevationGain.toLocaleString()} ft ‚Ä¢ ${tour.distance} mi ‚Ä¢ 
                        ${tour.terrain}
                    </div>
                </div>
            `;
        }

        function clearSearch() {
            console.log('üßπ Clearing search (recommendations unaffected)');
            
            // Reset search state
            searchState.query = '';
            searchState.zoneFilter = 'all';
            searchState.isActive = false;

            // Clear inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('searchZoneFilter').value = 'all';

            // Hide search results container
            document.getElementById('searchResultsContainer').classList.remove('active');
            document.getElementById('searchResultsList').innerHTML = '';

            console.log('‚úÖ Search cleared, recommended tours remain:', recommendationState.zone);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('load', () => {
            console.log('üöÄ App initialized');
            console.log('   Recommendation state:', recommendationState);
            console.log('   Search state:', searchState);
            
            // Ensure welcome is shown, dashboard hidden
            document.getElementById('welcomeMessage').style.display = 'block';
            document.getElementById('mainDashboard').style.display = 'none';
        });
    </script>
</body>
</html>
